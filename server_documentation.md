# Synclo Server Documentation

This document provides a comprehensive guide to the Synclo Backend for client-side development. It covers the server's architecture, authentication flow (including end-to-end encryption details), WebSocket protocol, and REST API endpoints.

## 1. Overview

The Synclo Backend is a FastAPI-based application using SQLite (via SQLAlchemy) for data persistence. It is designed with privacy in mind, employing a "zero-knowledge" architecture where the server stores encrypted data but cannot decrypt it (the Master Key is encrypted by the client).

**Tech Stack:**
- **Framework:** FastAPI (Python)
- **Database:** SQLite
- **Real-time:** WebSockets (managed by [ConnectionManager](file:///e:/Files/Code-Stuff/Projects/Synclo-Backend/connection_manager.py#6-111), scalable via Redis)
- **Security:** OAuth2 (JWT), Bcrypt (Auth Key Hashing)

## 2. Authentication & Security

Synclo separates authentication from data encryption.

### Key Concepts
- **Email**: User identifier.
- **Auth Key**: Derived on the client client-side from the user's password and a salt. This is hashed (Bcrypt) and stored on the server to verify login. **The server never sees the raw password.**
- **Master Key (MK)**: Randomly generated by the client during registration. It encrypts the user's data (clipboard content).
- **Encrypted Master Key**: The MK is encrypted using the user's derived key and stored on the server. Upon login, the client retrieves this, decrypts it locally, and uses the raw MK to decrypt clipboard data.
- **Device ID**: A unique identifier for each client device. Required for all operations.

### Flow
1.  **Registration**:
    - Client generates random `Master Key`.
    - Client generates random [Salt](file:///e:/Files/Code-Stuff/Projects/Synclo-Backend/schemas.py#70-73).
    - Client derives `Derived Key` from (Password + Salt).
    - Client derives `Auth Key` from `Derived Key`.
    - Client encrypts `Master Key` using `Derived Key` -> `Encrypted MK`.
    - Client sends: Email, Auth Key (base64), Device ID, Encrypted MK (base64), Salt (base64).

2.  **Login**:
    - Client requests user's Salt (`GET /auth/salt`).
    - Client derives `Derived Key` and `Auth Key`.
    - Client sends: Email, Auth Key, Device ID.
    - Server verifies Auth Key hash.
    - Server returns: Access Token (JWT), Refresh Token, Encrypted MK, Salt.
    - Client decrypts Encrypted MK to restore `Master Key`.

## 3. WebSocket Protocol

Used for real-time clipboard synchronization.

**Endpoint:** `ws://<HOST>/ws/clipboard?token=<ACCESS_TOKEN>`

### Connection
- **Protocol**: `wss://` (secure) or `ws://` (local).
- **Query Param**: [token](file:///e:/Files/Code-Stuff/Projects/Synclo-Backend/main.py#514-579) is the JWT Access Token obtained during login/registration.
- **Validation**: Token must be valid and not expired.

### Message Format (Client -> Server)
The client sends this JSON to update the clipboard. The Client is the authority on IDs and Timestamps.

```json
{
  "id": "uuid_string",
  "ciphertext": "base64_encoded_encrypted_data",
  "nonce": "base64_encoded_iv",
  "blob_version": 1,
  "timestamp": "ISO8601_string"
}
```
- **id**: A unique UUID v4 generated by the client at creation time. Used for idempotency and updates.
- **ciphertext**: The clipboard content encrypted with the Master Key.
- **nonce**: The initialization vector used for encryption.
- **blob_version**: Protocol version (currently `1`).
- **timestamp**: ISO 8601 timestamp of when the item was created/copied.

### Message Format (Server -> Client)
The server broadcasts the exact message received from the client to all *other* connected devices.

```json
{
  "id": "uuid_string",
  "ciphertext": "base64_encoded_encrypted_data",
  "nonce": "base64_encoded_iv",
  "blob_version": 1,
  "timestamp": "ISO8601_string"
}
```

### Heartbeat (Ping/Pong)
To keep the connection alive:
- **Client**: Sends `{"type": "ping"}`
- **Server**: Responds `{"type": "pong"}`

### Error Handling
Server sends error messages in this format:
```json
{
  "type": "error",
  "message": "Error description"
}
```
**Close Codes:**
- `1000`: Normal closure.
- `1008`: Policy violation (auth failed).
- `4001`: Token expired.
- `4002`: Ping/Pong timeout.
- `1011`: Internal server error.

## 4. REST API Reference

All protected endpoints require `Authorization: Bearer <token>` header.

### Authentication

#### `GET /auth/salt`
Get salt for key derivation.
- **Query**: [email](file:///e:/Files/Code-Stuff/Projects/Synclo-Backend/main.py#135-152)
- **Response**: `{"salt": "base64...", "kdf_version": 1}`
- **Error**: 404 if email not found.

#### `POST /register`
Register a new user and device.
- **Body**:
    ```json
    {
      "email": "user@example.com",
      "auth_key": "base64...",
      "device_id": "unique_device_id",
      "device_name": "My Laptop",
      "encrypted_master_key": "base64...",
      "salt": "base64...",
      "kdf_version": 1
    }
    ```
- **Response**: `{"access_token": "...", "refresh_token": "...", "token_type": "bearer"}`

#### `POST /login`
Login and get tokens.
- **Body**:
    ```json
    {
      "email": "user@example.com",
      "auth_key": "base64...",
      "device_id": "device_id",
      "device_name": "Optional Name"
    }
    ```
- **Response**: Returns tokens plus `encrypted_master_key`, [salt](file:///e:/Files/Code-Stuff/Projects/Synclo-Backend/main.py#135-152), `kdf_version` to restore session.

#### `POST /refresh`
Refresh access token.
- **Body**: `{"refresh_token": "..."}`
- **Response**: New access & refresh tokens. **Note:** Operates with Refresh Token Rotation.

#### `POST /logout`
Logout current device.
- **Body**: `{"refresh_token": "..."}`
- **Header**: Valid Access Token.

#### `POST /password/change`
Change password (re-wraps Master Key).
- **Body**:
    ```json
    {
      "old_auth_key": "...",
      "new_auth_key": "...",
      "new_encrypted_master_key": "...", 
      "new_salt": "...",
      "new_kdf_version": 1
    }
    ```

### Devices

#### `POST /devices/register`
Add a new device to an existing account (while logged in).
- **Body**: `{"device_id": "...", "device_name": "..."}`

#### `GET /devices`
List all devices.

#### `DELETE /devices/{device_id}`
Remove a device and revoke its tokens.

### Clipboard (REST)
*Note: Primary sync should happen via WebSocket, but REST is available for initial load or as fallback.*

#### `GET /clipboard`
Get the latest clipboard entry.

#### `POST /clipboard`
Push a new clipboard entry.
- **Body**: 
    ```json
    {
      "id": "uuid_string",
      "ciphertext": "...", 
      "nonce": "...", 
      "blob_version": 1, 
      "timestamp": "ISO8601"
    }
    ```

#### `GET /clipboard/all`
Get clipboard history with pagination.
- **Query**: `page=1`, `limit=50`.

#### `DELETE /clipboard/{clipboard_id}`
Delete a specific entry.

#### `DELETE /clipboard`
Clear all history.

### User Account

#### `DELETE /delete`
**DANGER**: Deletes the user account, all data, and all devices permanently.

## 5. Rate Limiting
Most endpoints are rate-limited (e.g., 5-30 requests per minute). Ensure the client handles `429 Too Many Requests`.
